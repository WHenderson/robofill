<div class="ui raised segment anu-flex-row">
    <div ref:flexLabel>
        <div ref:typeLabel class="ui {{scriptItem.enabled && category.color || 'grey'}} label">{{template.label || scriptItem.type}}</div>
    </div>
    <div class="anu-flex-col anu-flex-content">
        <div class="anu-flex-row">
            <div ref:item class="anu-flex-content">
                <div class="ui form">
                    {{#each Object.values(template.fields || {}) as fieldTemplate}}
                    {{#if ['text', 'trilean', 'selector'].includes(fieldTemplate.resultType) }}
                        {{#if fieldTemplate.resultType === 'trilean' && scriptItem[fieldTemplate.name].type === 'value'}}
                        <div class="field">
                            <label>{{fieldTemplate.label || name}}</label>
                            <div class="inline fields">
                                <div class="field">
                                    <label class="ui icon button" on:click="onChangeFieldType(event, fieldTemplate, scriptItem[fieldTemplate.name])">
                                        <i class="font icon" title="Value"></i>
                                    </label>
                                    <div class="ui radio checkbox">
                                        <input type="radio" checked="{{scriptItem[fieldTemplate.name].value === true}}" on:click="onSetFieldValue(event, fieldTemplate, scriptItem[fieldTemplate.name], true)">
                                        <label>Checked</label>
                                    </div>
                                    <div class="ui radio checkbox">
                                        <input type="radio" checked="{{scriptItem[fieldTemplate.name].value === false}}" on:click="onSetFieldValue(event, fieldTemplate, scriptItem[fieldTemplate.name], false)">
                                        <label>Unchecked</label>
                                    </div>
                                    <div class="ui radio checkbox">
                                        <input type="radio" checked="{{scriptItem[fieldTemplate.name].value !== true && scriptItem[fieldTemplate.name].value !== false}}" on:click="onSetFieldValue(event, fieldTemplate, scriptItem[fieldTemplate.name], undefined)">
                                        <label>Indeterminate</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {{else}}
                        <div class="field">
                            <label>{{fieldTemplate.label || name}}</label>
                            <div class="ui left action input">
                                <button class="ui icon button" on:click="onChangeFieldType(event, fieldTemplate, scriptItem[fieldTemplate.name])">
                                    {{#if scriptItem[fieldTemplate.name].type === 'formula'}}
                                    <i class="superscript icon" title="Formula"></i>
                                    {{elseif scriptItem[fieldTemplate.name].type === 'code'}}
                                    <i class="code icon" title="Code"></i>
                                    {{else}}
                                    <i class="font icon" title="Value"></i>
                                    {{/if}}
                                </button>
                                {{#if multiline}}
                                    {{#if scriptItem[fieldTemplate.name].type === 'value'}}
                                    <textarea type="text" placeholder="{{fieldTemplate.label || name}}" bind:value="scriptItem[fieldTemplate.name].value"></textarea>
                                    {{elseif scriptItem[fieldTemplate.name].type === 'formula'}}
                                    <textarea type="text" placeholder="{{fieldTemplate.label || name}}" bind:value="scriptItem[fieldTemplate.name].formula"></textarea>
                                    {{elseif scriptItem[fieldTemplate.name].type === 'code'}}
                                    <textarea type="text" placeholder="{{fieldTemplate.label || name}}" bind:value="scriptItem[fieldTemplate.name].code"></textarea>
                                    {{/if}}
                                {{else}}
                                    {{#if scriptItem[fieldTemplate.name].type === 'value'}}
                                    <input type="text" placeholder="{{fieldTemplate.label || name}}" bind:value="scriptItem[fieldTemplate.name].value">
                                    {{elseif scriptItem[fieldTemplate.name].type === 'formula'}}
                                    <input type="text" placeholder="{{fieldTemplate.label || name}}" bind:value="scriptItem[fieldTemplate.name].formula">
                                    {{elseif scriptItem[fieldTemplate.name].type === 'code'}}
                                    <input type="text" placeholder="{{fieldTemplate.label || name}}" bind:value="scriptItem[fieldTemplate.name].code">
                                    {{/if}}
                                {{/if}}
                            </div>
                        </div>
                        {{/if}}
                    {{/if}}
                    {{/each}}
                </div>
            </div>
            <div ref:menuArrange class="ui right vertical icon menu anu-item-menu">
                <slot name="menuItemsTop"></slot>
                <!--
                <a class="item" on:click="fire('up', { scriptItem })">
                    <i class="angle up icon"></i>
                </a>
                -->
                <slot name="menuItemEnable">
                    <a class="item" on:click="onItemEnableToggle(event)">
                        <i class="{{scriptItem.enabled ? 'check' : 'ban'}} icon"></i>
                    </a>
                </slot>
                <!--
                <a class="item" on:click="fire('delete', { scriptItem })">
                    <i class="trash icon"></i>
                </a>
                <a class="item" on:click="fire('down', { scriptItem })">
                    <i class="angle down icon"></i>
                </a>
                -->
                <slot name="menuItemsBottom"></slot>
            </div>
        </div>
        {{#if template.hasSubScript}}
        <div class="anu-flex-content">
            <ScriptItemsEdit scriptItems="{{scriptItem.scriptItems}}"/>
        </div>
        {{/if}}
    </div>
</div>

<style>
    .anu-flex-row {
        display: flex;
        flex-direction: row;
        align-items: stretch;
        padding: 0;
    }
    .anu-flex-col {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        padding: 0;
    }
    .anu-flex-content {
        flex-grow: 1;
    }

    ref:item {
        padding-top: 0.5em;
        padding-left: 0.5em;
        padding-right: 0.5em;
    }

    .anu-script-item-menu .item:hover .check.icon {
        color: #21ba45;
    }
    .anu-script-item-menu .item:hover .trash.icon {
        color: #db2828;
    }

    .anu-item-menu {
        margin: 0.5em;
    }

    ref:flexLabel {
        position: relative;
        width: 24px;
    }
    ref:typeLabel {
        position: absolute;
        border-top-left-radius: 0;
        border-top-right-radius: 0;
        border-bottom-left-radius: 0;

        writing-mode: vertical-lr;
        padding: 0.5em;
        display: block;
        height: 100%;
        width: 2em;
    }

    ref:menuArrange {
        margin: 0;
        border-top-left-radius: 0;
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
        border-top: none;
        border-right: none;
    }
</style>

<script>
    import { templates, categories } from '../lib/category-template-mapping.es6';
    import ScriptItemsEdit from './script-items-edit.html'

    export default {
        setup(Directive) {
        },
        data() {
            return {
                scriptItem: {},
                multiline: false
            }
        },
        helpers: {
            templates,
            categories
        },
        computed: {
            template: (scriptItem) => scriptItem && templates[scriptItem.type] || {},
            category: (template) => template.category || {}
        },
        oncreate() {
            this.observe('scriptItem', (scriptItem) => console.log('changed', scriptItem));
        },
        ondestroy() {
        },
        methods: {
            onItemEnableToggle(event) {
                event.preventDefault();

                const scriptItem = this.get('scriptItem');
                scriptItem.enabled = !scriptItem.enabled;
                this.set({ scriptItem });
            },
            onChangeFieldType(event, fieldTemplate, field) {
                event.preventDefault();

                const multiline = !this.get('multiline');

                if (!multiline || (fieldTemplate.resultType === 'trilean' && field.type === 'value')) {
                    switch (field.type) {
                        case 'value':
                            field.type = 'formula';
                            field.formula = field.formula || '';
                            break;
                        case 'formula':
                            field.type = 'code';
                            field.code = field.code || '';
                            break;
                        default:
                            field.type = 'value';
                            break;
                    }
                }

                this.set({ scriptItem: this.get('scriptItem'), multiline });
            },
            onSetFieldValue(event, fieldTemplate, field, value) {
                //event.preventDefault();

                field.value = value;
                this.set({ scriptItem: this.get('scriptItem') });
                return false;
            }
        },
        events: {
        },
        components: {
            ScriptItemsEdit
        }
    };
</script>