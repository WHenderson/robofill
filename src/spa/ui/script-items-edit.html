<div>
    <div ref:add class="ui menu">
        {{#each Object.values(categories) as category}}
        <div class="ui dropdown item" title="{{category.description}}">
            <i class="add icon"></i>
            {{category.label}}
            <i class="dropdown icon"></i>
            <div class="menu">
                {{#if category.sub}}
                    {{#each Object.values(category.sub) as sub}}
                        <div class="header" title="{{sub.description}}">{{sub.label}}</div>
                        {{#each (sub.templates || []) as template}}
                        <div class="item" title="{{template.description}}" on:click="onAdd(template)">
                            <div class="ui {{sub.color}} empty circular label"></div>
                            {{template.label}}
                        </div>

                        {{/each}}
                    {{/each}}
                {{else}}
                    {{#each (category.templates || []) as template}}
                    <div class="item" title="{{template.description}}" on:click="onAdd(template)">
                        <div class="ui {{category.color}} empty circular label"></div>
                        {{template.label}}
                    </div>
                    {{/each}}
                {{/if}}
            </div>
        </div>
        {{/each}}
    </div>

    <div ref:scriptSegments class="ui segments">
        {{#each (scriptItems || []) as scriptItem}}
        <ScriptItemEdit :scriptItem on:up="onItemUp(event)" on:down="onItemDown(event)" on:delete="onItemDelete(event)" />
        {{/each}}
    </div>
</div>

<script>
    import ScriptItemEdit from './script-item-edit.html'
    import { templates, categories } from '../lib/category-template-mapping.es6';

    export default {
        setup(Directive) {
        },
        data() {
            return {
                scriptItems: []
            }
        },
        helpers: {
            templates,
            categories
        },
        computed: {
        },
        oncreate() {
            $(this.refs.tabs).find('.item')
                .tab();

            $(this.refs.add).find('.ui.dropdown')
                .dropdown();
        },
        ondestroy() {
        },
        methods: {
            onItemUp({ scriptItem }) {
                const scriptItems = this.get('scriptItems');
                const index = scriptItems.indexOf(scriptItem);
                if (index !== 0) {
                    this.set({
                        scriptItems:
                            scriptItems
                                .slice(0, index-1)
                                .concat([scriptItem])
                                .concat([scriptItems[index-1]])
                                .concat(scriptItems.slice(index + 1))
                    })
                }
            },
            onItemDown({ scriptItem }) {
                const scriptItems = this.get('scriptItems');
                const index = scriptItems.indexOf(scriptItem);
                if (index !== scriptItems.length - 1) {
                    this.set({
                        scriptItems:
                            scriptItems
                                .slice(0, index)
                                .concat([scriptItems[index + 1]])
                                .concat([scriptItem])
                                .concat(scriptItems.slice(index + 2))
                    })
                }
            },
            onItemDelete({ scriptItem }) {
                const scriptItems = this.get('scriptItems');
                this.set({ scriptItems: scriptItems.filter(si => si !== scriptItem )});
            },
            onAdd(item) {
                const scriptItems = this.get('scriptItems');
                this.set({
                    scriptItems: scriptItems.concat([item.template()])
                })
            }
        },
        events: {
        },
        components: {
            ScriptItemEdit
        }
    };
</script>